---
title: 'The Collapse of the American Dream: *From Rags to Riches to The Ragged and
  The Rich*'
author:
- John Wu
- Connie Lu
- Smriti Vijay
- Gwyneth Gao
- Alvin Li
output:
  pdf_document: default
  ioslides_presentation: default
  slidy_presentation: default
  beamer_presentation:
    slide_level: 3
    theme: Boadilla
  html_document:
    df_print: paged
always_allow_html: true
header-includes:
- \AtBeginSection[]{\begin{frame}\tableofcontents[currentsection]\end{frame}}
- \AtBeginSubsection[]{\begin{frame}\tableofcontents[currentsubsection]\end{frame}{}}
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(ggrepel)
library(car)
library(glmnet)
library(randomForest)
library(rpart)
library(rpart.plot)
```

# EDA

## Importing All Excel Sheets

```{r, echo=FALSE}
country_tuition <- (read_excel("data/WDS Project.xlsx"))
country_tuition <- country_tuition %>%
  mutate(`Tuition Fees in USD Thousands` = `Tuition Fees in USD` / 1000) %>%
  mutate(`Tuition Fees in USD Thousands less 0` = na_if(`Tuition Fees in USD Thousands`, 0)) %>%
  select(-'Cost of One Year at University(â‚¬)', -`Tuition Fees in USD`, -`Tuition Fees in USD Thousands`) 
  

health_index <- (read_excel("data/WDS Project.xlsx", sheet = "Health Index Country"))

education_index <- (read_excel("data/WDS Project.xlsx", sheet = "Education Index"))
education_index <- education_index %>%
  rename('Education Index' = '2021 Education Index')

top_1_share_country <- (read_excel("data/WDS Project.xlsx", sheet = "Country 1% Share"))
top_1_share_country <- top_1_share_country %>%
  rename('Wealth Share Top 1%' = '% of income of the richest 1%')

welfare_country <- (read_excel("data/WDS Project.xlsx", sheet = "Country Social GDP"))
welfare_country  <- welfare_country %>%
  rename('Welfare Spending % GDP' = 'Social Welfare Spending as % of GDP - 2019') 

gini_country <- (read_excel("data/WDS Project.xlsx", sheet = "Gini Country"))

mobility_index <- (read_excel("data/WDS Project.xlsx", sheet = "Global Social Mobility Index")) 
mobility_index <- mobility_index %>%
  rename('Social Mobility Index' = 'Index Score') %>%
  select(-'Rank')

house_affordability_country <- (read_excel('data/WDS Project.xlsx', sheet = 'House Affordability Index'))
house_affordability_country <- house_affordability_country %>%
  mutate('Affordable Housing' = ifelse(`Mortgage as a % of Income` <= 1, 1, 0))

corruption_index <- (read_excel('data/WDS Project.xlsx', sheet = 'Corruption Country'))

corruption_index <- corruption_index %>%
  rename('Corruption Perception' = 'CPI Score - 2023')

universal_healthcare <- (read_excel('data/WDS Project.xlsx', sheet = 'Universal Healthcare'))

poverty_rate <- (read_excel('data/WDS Project.xlsx', sheet = 'Country Poverty'))

GDP_country <- (read_excel('data/WDS Project.xlsx', sheet = 'GDP Country'))
GDP_country <- GDP_country 
 # mutate(`GDP Per Capita` = `GDP Per Capita` / 1000)




```


```{r, echo = F}
#importing medicare prem
medicare_prem <- (read_excel("data/WDS Project.xlsx", sheet = 'Medicare Premiums'))
#cleaning up medicare prem
medicare_prem <- medicare_prem %>%
  select(-'Standard Monthly Premium (Before Income Adjustments)', - 'Value in 2024 Dollars')

#importing US house price index
house_price_us <- (read_excel("data/WDS Project.xlsx", sheet = 'US House Price Index'))
#cleaning up US house price index
house_price_us <- house_price_us %>%
   rename('House Price Index' = 'House Price Index - Real Dollars') %>%
  select(Year, `House Price Index`)

#importing tuition
tuition_us <- (read_excel("data/WDS Project.xlsx", sheet = 'Tuition v Time'))
#cleaning up tuition
tuition_us <- tuition_us %>%
  select(-'Total tuition, fees, room, and board - All Institutions (Public & Private) - Nominal Dollars', - 'Total tuition, fees, room, and board - All Institutions (Public & Private) - 2022 Dollars')

#importing child surpass
child_surpass_us <- (read_excel("data/WDS Project.xlsx", sheet = 'P( Children Inc. Surpass Fath)'))
#cleaning up child surpass
child_surpass_us <- child_surpass_us %>%
   rename('fs_p25' = 'abs_mob_pos_par_fs_ind_p25' , 'fs_p50' =  'abs_mob_pos_par_fs_ind_p50', 'fs_p75' =  'abs_mob_pos_par_fs_ind_p75' ,  'fd_p25' = 'abs_mob_pos_par_fd_ind_p25', 'fd_p50' = 'abs_mob_pos_par_fd_ind_p50', 'fd_p75' = 'abs_mob_pos_par_fd_ind_p75')

#importing median income
med_income_us <- (read_excel("data/WDS Project.xlsx", sheet = 'Median Income Time'))
#cleaning up median income
med_income_us <- med_income_us %>%
   select(-'Real Median Income')

#importing personal savings rate
save_rate <- (read_excel("data/WDS Project.xlsx", sheet = 'Save Rate Time'))

#importing gini
gini_us <- (read_excel("data/WDS Project.xlsx", sheet = 'Gini Time'))

#importing share of wealth owned by certain percentage
wealth_share_us<- (read_excel("data/WDS Project.xlsx", sheet = 'Time Wealth Share'))
#cleaning up  share of wealth owned by certain percentage
wealth_share_us <- wealth_share_us %>%
   rename('Wealth of lower 50%' = 'Share of Total Wealth Owned by Lowest 50%', 'Wealth of top 1%' = 'Share of Total Wealth Owned by Top 1%')

```


## JOINING DATA
```{r}
country_data <- (mobility_index %>%
  full_join(health_index, by = 'Country') %>%
  full_join(education_index, by = 'Country') %>%
  full_join(top_1_share_country, by = 'Country') %>%
  full_join(welfare_country, by ='Country') %>%
  full_join(gini_country, by = 'Country') %>%
  full_join(country_tuition, by = 'Country') %>%
  full_join(house_affordability_country, by = 'Country') %>%
  full_join(corruption_index, by = 'Country') %>%
  full_join(universal_healthcare, by='Country') %>%
  full_join(GDP_country, by='Country') %>%
  full_join(poverty_rate, by='Country'))[1:82,]


country_data <- country_data %>%
  mutate(`Universal Healthcare` = ifelse(is.na(`Universal Healthcare`), 'No', `Universal Healthcare`)) %>%
  mutate(`Universal Healthcare` = factor(`Universal Healthcare`)) %>%
  mutate(`Affordable Housing` = ifelse(`Affordable Housing` == 1, 'Yes', 'No')) %>%
  mutate(`Affordable Housing` = factor(`Affordable Housing`)) %>%
  select(-GDP)

refined_country_data <- country_data %>%
  select(-`Universal Healthcare`, - Country, -`Tuition Fees in USD Thousands less 0`)


expenditures <- medicare_prem %>%
  full_join(house_price_us, by = 'Year') %>%
  full_join(tuition_us, by = 'Year') %>%
  full_join(med_income_us, by = 'Year') %>%
  select(`Year`, `Healthcare Premium Index`, `House Price Index`, `Tuition Index`, `Median Income Index`)

expenditures_data_long <- expenditures %>%
  pivot_longer(cols= - Year, names_to ='Expenditures', values_to = 'Values')


surpass_data_long <- child_surpass_us %>%
  pivot_longer(cols = - Year, names_to = "Groups", values_to = "Percent")

wealth_share_long <- wealth_share_us %>%
  pivot_longer(cols= -Year, names_to = 'Groups', values_to = 'Percent')

fituniversal <- lm(`Social Mobility Index` ~ `Universal Healthcare` + `Affordable Housing`, country_data)
summary(fituniversal)

```

## Visualizing

```{r}
ggplot(expenditures_data_long, aes(x = Year, y = Values, col = Expenditures)) +
  geom_smooth(se = FALSE, size = 1) +
  theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA), # Light gray background
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1), # Dark blue border
    panel.grid.major = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.grid.minor = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1), # Dark blue border
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.background = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.box.background = element_blank(), # Remove the box around the legends
    legend.key = element_rect(fill = "#FAFAFAFF", color = NA), # Remove the border around the legend keys
    legend.key.border = element_blank(), # Ensure there is no border around the keys
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D")
  ) +
  labs(
    title = "Expenditures Over Time",
    x = "Year",
    y = "Index"
  )
#scale_color_manual(labels = c("Father-Daughter 25th", "Father-Daughter 50th", "Father-Daughter 75th", "Father-Son 25th", "Father-Son 50th", "Father-Son 75th"))

surpass_data_long_mod<-surpass_data_long%>%mutate( Percent = Percent * 100)
surpass_data_long_mod<-surpass_data_long_mod %>%
  mutate(Groups = if_else(Groups == "fd_p25", "Father-Daughter 25th", if_else(Groups == "fd_p50", "Father-Daughter 50th", if_else(Groups == "fd_p75", "Father-Daughter 75th", if_else(Groups == "fs_p25", "Father-Son 25th", if_else(Groups == "fs_p50", "Father-Son 50th", if_else(Groups == "fs_p75", "Father-Son 75th", Groups)))))))
ggplot(surpass_data_long_mod, aes(x=Year, y= Percent, col = Groups)) +
  geom_smooth(se=F)+theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA), # Light gray background
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1), # Dark blue border
    panel.grid.major = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.grid.minor = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1), # Dark blue border
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.background = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.box.background = element_blank(), # Remove the box around the legends
    legend.key = element_rect(fill = "#FAFAFAFF", color = NA), # Remove the border around the legend keys
    legend.key.border = element_blank(), # Ensure there is no border around the keys
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D")
  ) +
  
  labs(
    title = "Percent of Children Surpassing Father's Income",
    x = "Year Children Born in",
    y = "Percent"
  ) 

ggplot(gini_us, aes(x=Year, y=`Gini Coefficient`)) +
   geom_rect(aes(xmin = 1980 - 0.5, xmax = 1980 + 9, ymin = -Inf, ymax = Inf),
            fill = "grey80", alpha = 0.5) +
   geom_smooth(se=F,color = "#2C5F8D")+ theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA), # Light gray background
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1), # Dark blue border
    panel.grid.major = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.grid.minor = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1), # Dark blue border
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.key.border = element_blank(), # Ensure there is no border around the keys
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D")
  ) +
  labs(
    title = "Gini Coefficient Over Time",
    x = "Year",
    y = "Gini Coefficient"
  )+
  annotate("text", x = 1980, y = max(country_data$Value) * 0.9, 
           label = "Reaganomics Implementation", angle = 0, vjust = -25, hjust =1.05, color  = "#2C5F8D")

ggplot(wealth_share_long, aes(x=Year, y=Percent)) +
   geom_rect(aes(xmin = 1980 - 0.5, xmax = 1980 + 9, ymin = -Inf, ymax = Inf),
            fill = "grey80", alpha = 0.5)  +
  geom_smooth(aes(col=Groups),se=F)+scale_color_manual(values = c("#d0e1efff", "#2C5F8D")) +
  theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA), # Light gray background
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1), # Dark blue border
    panel.grid.major = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.grid.minor = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1), # Dark blue border
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.background = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.box.background = element_blank(), # Remove the box around the legends
    legend.key = element_rect(fill = "#FAFAFAFF", color = NA), # Remove the border around the legend keys
    legend.key.border = element_blank(), # Ensure there is no border around the keys
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D")
  ) +
  labs(
    title = "Wealth Share Percent Over Time",
    x = "Year",
    y = "Percent"
  )
ggplot(save_rate, aes(x=Year, y=`Personal Savings Rate`)) +
  xlim(1975, 2024) +
  ylim(2,20) +
  geom_rect(aes(xmin = 2020-2, xmax = 2022, ymin = -Inf, ymax = Inf),
            fill = "grey80", alpha = 0.5) +
  annotate("text", x = 2020, y = max(country_data$Value) * 0.9, 
           label = "COVID-19", angle = 0, vjust = -25, hjust = 1.5) +
  geom_point(col='#2C5F8D') + theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA), # Light gray background
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1), # Dark blue border
    panel.grid.major = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.grid.minor = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1), # Dark blue border
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.background = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.box.background = element_blank(), # Remove the box around the legends
    legend.key = element_rect(fill = "#FAFAFAFF", color = NA), # Remove the border around the legend keys
    legend.key.border = element_blank(), # Ensure there is no border around the keys
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D")
  ) +
  labs(
    title = "Savings Rate Over Time",
    x = "Year",
    y = "Personal Savings Rate"
  )

```


## PLOTTING

```{r}
summary(country_data)
dim(country_data)


ggplot(country_data, aes(x = Country, y = `Education Index`)) +
  geom_point(color = 'lightblue') +  # Plot points
  geom_label_repel(aes(label = Country), size = 2) +  # Add labels with automatic adjustment
  theme_minimal() +
  theme(axis.text.x = element_blank())+theme_bw()


## Testing for Correlation


ggplot(country_data, aes(x=`Education Index`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Gini Coefficient`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Health Care Index`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Health Expenditure Index`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Wealth Share Top 1%`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Welfare Spending % GDP`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Tuition Fees in USD Thousands less 0`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Housing Affordability Index`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Mortgage as a % of Income`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Price to Income Ratio`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(x=`Corruption Perception`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(country_data, aes(y=`Social Mobility Index`, x=`Affordable Housing`)) +
  geom_point(aes(color = factor(`Affordable Housing`))) +
  geom_smooth(method= 'glm', method.args = list(family = 'binomial'), se = F)+theme_bw()
ggplot(refined_country_data, aes(x=`Social Mobility Index`, y=`Poverty Rate`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(refined_country_data, aes(x=`Gini Coefficient`, y=`Poverty Rate`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(refined_country_data, aes(x=`Education Index`, y=`Poverty Rate`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(refined_country_data, aes(x=`Social Mobility Index`, y=`GDP Per Capita`)) +
  geom_smooth(se=F)+theme_bw()
ggplot(refined_country_data, aes(x=`Education Index`, y=`GDP Per Capita`)) +
  geom_smooth(se=F)+theme_bw()

ggplot(refined_country_data, aes(x=`Housing Affordability Index`, y=`Poverty Rate`)) +
geom_smooth(se=F)+theme_bw()

ggplot(refined_country_data, aes(x=`Mortgage as a % of Income`, y=`Poverty Rate`)) +
geom_smooth(se=F)+theme_bw()
ggplot(refined_country_data, aes(y=`GDP Per Capita`, x=`Poverty Rate`)) +
geom_smooth(se=F)+theme_bw()

ggplot(refined_country_data, aes(x=`Gini Coefficient`, y=`GDP Per Capita`)) +
geom_smooth(se=F)+theme_bw()

ggplot(refined_country_data, aes(x=`Welfare Spending % GDP`, y=`GDP Per Capita`)) +
geom_smooth(se=F)+theme_bw()

ggplot(refined_country_data, aes(x=`Health Care Index`, y=`GDP Per Capita`)) +
geom_smooth(se=F)+theme_bw()

```


# Data Preparation


```{r}

set.seed(123)

refined_country_data <- refined_country_data %>%
  mutate(`GDP Per Capita` = `GDP Per Capita` / 1000)

no_na <- refined_country_data[complete.cases(refined_country_data), ] %>%
  select(-Rank) 



testing_indices2 <- sample(nrow(no_na), 5)

c.data.test2 <- no_na[testing_indices2, ]

no_na.notest <- no_na[-testing_indices2,]
no_na.notest <- no_na.notest %>%
  select(-`Affordable Housing`) 
no_na.test <- no_na[testing_indices2, ] %>%
  select(-`Affordable Housing`)

test_rows <- which(row.names(refined_country_data) %in% row.names(c.data.test2))

c.data.notest2 <- refined_country_data[-test_rows, ] %>%
  select(-Rank)


```

# Data Analysis 

## LM, LASSO, & RELAXED LASSO


```{r}

predictors <- no_na.notest %>%
  select(-`Social Mobility Index`)
predictors <- model.matrix(~., data=predictors)[,-1]

# force_in_education <- ifelse(grepl('Education Index', colnames(predictors)), 0, 1)
# 
# lasso_education_smi_ed <- cv.glmnet(predictors, no_na.notest$`Social Mobility Index`, alpha=1, penalty.factor = force_in_education)
# 
# coef(lasso_education_smi_ed, s='lambda.min')
# 
# relaxed_lasso_smi_ed <- lm(`Social Mobility Index` ~ `Health Expenditure Index` + `Education Index` + `Welfare Spending % GDP` + `Gini Coefficient` + `Housing Affordability Index` + `Corruption Perception` + `GDP Per Capita` + `Poverty Rate`, data=c.data.notest2)
# summary(relaxed_lasso_smi_ed)

lasso_smi <- cv.glmnet(predictors, no_na.notest$`Social Mobility Index`, alpha=1)
coef(lasso_smi, s= 'lambda.min')

relaxed_lasso_smi <- lm(`Social Mobility Index` ~ `Health Expenditure Index` + `Wealth Share Top 1%` + `Gini Coefficient` + `Corruption Perception` + `GDP Per Capita` +`Poverty Rate`, c.data.notest2)
summary(relaxed_lasso_smi)

lm_smi <- lm(`Social Mobility Index` ~ `Education Index` +`Wealth Share Top 1%` + `Welfare Spending % GDP` + `Corruption Perception` + `Health Care Index` + `Housing Affordability Index`, data=refined_country_data)
summary(lm_smi)


# POVERTY

predictorspov <- no_na.notest %>%
  select(-`Poverty Rate`)
predictorspov <- model.matrix(~., data=predictorspov)[,-1]

force_in_education_pov <- ifelse(grepl('Education Index', colnames(predictorspov)), 0, 1)

lasso_pov <- cv.glmnet(predictorspov, no_na.notest$`Poverty Rate`, alpha=1, penalty.factor = force_in_education_pov)

# lasso_pov_noed <- cv.glmnet(predictorspov, no_na.notest$`Poverty Rate`, alpha=1)
# coef(lasso_pov_noed)

coef(lasso_pov, s='lambda.min')

relaxed_lasso_pov <- lm(`Poverty Rate` ~ `Social Mobility Index` + `Health Care Index` + `Education Index` + `Wealth Share Top 1%` + `Welfare Spending % GDP` + `Gini Coefficient` + `Mortgage as a % of Income` + `Price to Income Ratio` + `Corruption Perception` + `GDP Per Capita`, data=c.data.notest2)

summary(relaxed_lasso_pov)


lm_pov <- lm(`Poverty Rate` ~ . - `Health Care Index` -`Health Expenditure Index` - `% of World GDP` - `Education Index`- `Affordable Housing` - `Wealth Share Top 1%` - `Mortgage as a % of Income` - `Welfare Spending % GDP`,c.data.notest2)
summary(lm_pov)



# GDP
predictorsgdp <- no_na.notest %>%
  select(-`GDP Per Capita`)
predictorsgdp <- model.matrix(~., data=predictorsgdp)[,-1]

lasso_gdp <- cv.glmnet(predictorsgdp, no_na.notest$`GDP Per Capita`, alpha=1)
coef(lasso_gdp)

relaxed_lasso_gdp <- lm(`GDP Per Capita` ~ `Education Index` + `Corruption Perception`, c.data.notest2)
summary(relaxed_lasso_gdp)


lm_GDP <- lm(`GDP Per Capita` ~ . - `Mortgage as a % of Income` - `% of World GDP` - `Social Mobility Index` - `Education Index` - `Welfare Spending % GDP` - `Health Expenditure Index` - `Affordable Housing` - `Wealth Share Top 1%` -`Poverty Rate`, c.data.notest2)
summary(lm_GDP)

lm_GDP2 <- lm(`GDP Per Capita` ~ `Social Mobility Index` + `Education Index` + `Poverty Rate` + `Gini Coefficient`, c.data.notest2)
summary(lm_GDP2)

```

# testing log GDP

```{r}

c.data.notestlogGDP <- c.data.notest2 %>%
  mutate(logGDPPC = log(`GDP Per Capita`)) %>%
  select(-`GDP Per Capita`)


c.data.testlogGDP <- c.data.test2 %>%
  mutate(logGDPPC = log(`GDP Per Capita`)) %>%
  select(-`GDP Per Capita`)

ggplot(c.data.notestlogGDP, aes(x=`Corruption Perception`, y=`logGDPPC`)) +
geom_smooth(se=F)


lm_log_GDP <- lm(`logGDPPC` ~ `Housing Affordability Index`+ `Education Index` + `Health Care Index` + `Health Expenditure Index`, c.data.notestlogGDP)
summary(lm_log_GDP)
log.gdp.lm.p <- predict(lm_log_GDP, c.data.testlogGDP)
log.gdp.lm.mse <- mean((c.data.testlogGDP$`logGDPPC` - log.gdp.lm.p)^2)
exp(log.gdp.lm.mse)


predictorsgdp <- no_na.notest %>%
  select(-`GDP Per Capita`)
predictorsgdp <- model.matrix(~., data=predictorsgdp)[,-1]

no_na.notestloggdp <- no_na.notest %>%
  mutate(logGDPPC = log(`GDP Per Capita`)) %>%
  select(-`GDP Per Capita`)

no_na.testloggdp <- no_na.test %>%
  mutate(logGDPPC = log(`GDP Per Capita`)) %>%
  select(-`GDP Per Capita`)

lasso_log_gdp <- cv.glmnet(predictorsgdp, no_na.notestloggdp$logGDPPC, alpha=1)
coef(lasso_gdp)

log.gdp.lasso.p <- predict(lasso_log_gdp, model.matrix(`logGDPPC`~.,data = no_na.testloggdp)[,-1]) 

log.gdp.lasso.mse <- mean((c.data.testlogGDP$`logGDPPC` - log.gdp.lasso.p)^2)
log.gdp.lasso.mse

relaxed_lasso_log_gdp <- lm(`logGDPPC` ~ `Corruption Perception`, no_na.testloggdp)
summary(relaxed_lasso_log_gdp)
log.gdp.relaxed.lm.p <- predict(relaxed_lasso_log_gdp, c.data.testlogGDP)
log.gdp.relaxed.lm.mse <- mean((c.data.testlogGDP$`logGDPPC` - log.gdp.relaxed.lm.p)^2)
exp(log.gdp.relaxed.lm.mse) * 1000


log.gdp.fit_tree <- rpart(`logGDPPC`~., data = no_na.notestloggdp, control=rpart.control(minsplit=2, cp=0.01))
rpart.plot(log.gdp.fit_tree)
log.gdp.tree.p <- predict(log.gdp.fit_tree, no_na.testloggdp)
log.gdp.tree.mse <- mean((no_na.testloggdp$logGDPPC - log.gdp.tree.p)^2)
log.gdp.tree.mse

new_names2 <- c('SMI', 'HCI', 'HEI', 'EI', 'WST1', 'WSGDP', 'GINI', 'HAI', 'MPI', 'PIR', 'CP', 'PWGDP', 'PR', 'GDPPC' )

no_na.notestloggdp2 <- no_na.notestloggdp %>%
  rename_with(~new_names2) %>%
  rename(logGDPPC = GDPPC)

no_na.testloggdp2 <- no_na.testloggdp %>%
  rename_with(~new_names2) %>%
  rename(logGDPPC = GDPPC)


log.gdp.error.p <- 1:16 # set up a vector of length 16
for (p in 1:16) # repeat the following code inside { } 16 times
{
forest.log.gdp <- randomForest(`logGDPPC`~., no_na.notestloggdp2, mtry=p, ntree=250)
log.gdp.error.p[p] <- forest.log.gdp$mse[250] # collecting oob mse based on 250 trees
}
plot(1:16, log.gdp.error.p, ylim = c(6.5,6.6))
rf_log_gdp <- randomForest(logGDPPC~ . ,data=no_na.notestloggdp2, mtry=13, ntree=100)
rf_log_gdp.p <- predict(rf_log_gdp, no_na.testloggdp2)
rf_log_gdp.mse <- mean((no_na.testloggdp2$logGDPPC - rf_log_gdp.p)^2)
rf_log_gdp.mse

log.gdp.mse <- data.frame(log.gdp.lm.mse, log.gdp.lasso.mse, log.gdp.relaxed.lm.mse, log.gdp.tree.mse, rf_log_gdp.mse)
log.gdp.mse
1000 * exp(log.gdp.mse)

```


## TREE
```{r, echo=FALSE}
smi.fit_tree1 <- rpart(`Social Mobility Index`~., data = no_na.notest, control=rpart.control(minsplit=2, cp=0.01))
rpart.plot(smi.fit_tree1)


gdp.fit_tree1 <- rpart(`GDP Per Capita`~., data = no_na.notest, control=rpart.control(minsplit=2, cp=0.01))
rpart.plot(gdp.fit_tree1)

pov.fit_tree1 <- rpart(`Poverty Rate` ~., data= no_na.notest, control=rpart.control(minsplit=2, cp=0.01))
rpart.plot(pov.fit_tree1)

```

## RANDOM FORESTS

```{r, echo=FALSE}

new_names <- c('SMI', 'HCI', 'HEI', 'EI', 'WST1', 'WSGDP', 'GINI', 'HAI', 'MPI', 'PIR', 'CP', 'GDPPC', 'PWGDP', 'PR')

no_na.notest2 <- no_na.notest %>%
  rename_with(~new_names)
no_na.test2 <- no_na.test %>%
  rename_with(~new_names)

#mtry looping
smi.error.p <- 1:16 # set up a vector of length 16
for (p in 1:16) # repeat the following code inside { } 16 times
{
forest.smi <- randomForest(SMI~., no_na.notest2, mtry=p, ntree=250)
smi.error.p[p] <- forest.smi$mse[250] # collecting oob mse based on 250 trees
}
 # oob mse returned: should be a vector of 19
plot(1:16, smi.error.p)

rf_smi <- randomForest(SMI~ . ,data=no_na.notest2, mtry=5, ntree=100)


#mtry looping
pov.error.p <- 1:16 # set up a vector of length 16
for (p in 1:16) # repeat the following code inside { } 16 times
{
forest.pov <- randomForest(`PR`~., no_na.notest2, mtry=p, ntree=250)
pov.error.p[p] <-forest.pov$mse[250] # collecting oob mse based on 250 trees
}

plot(1:16, pov.error.p)
rf_pov <- randomForest(SMI~ . ,data=no_na.notest2, mtry=11, ntree=100)


#mtry looping
gdp.error.p <- 1:16 # set up a vector of length 16
for (p in 1:16) # repeat the following code inside { } 16 times
{
forest.gdp <- randomForest(`GDPPC`~., no_na.notest2, mtry=p, ntree=250)
gdp.error.p[p] <- forest.gdp$mse[250] # collecting oob mse based on 250 trees
}
plot(1:16, gdp.error.p)
rf_gdp <- randomForest(SMI~ . ,data=no_na.notest2, mtry=13, ntree=100)


```


## XG BOOSTS:
```{r}
install.packages("xgboost")
library(xgboost)

Xdata.train<-no_na.notest2%>%
  select(-PR,-SMI, -GDPPC)%>%as.matrix()
Ypov.train<-as.matrix(no_na.notest2$PR)
Ysmi.train<-as.matrix(no_na.notest2$SMI)
Ylgdp.train<-as.matrix(no_na.notestloggdp2$logGDPPC)

Xdata.test<-no_na.test2%>%
  select(-PR,-SMI, -GDPPC)%>%as.matrix()
Ypov.test<-as.matrix(no_na.test2$PR)
Ysmi.test<-as.matrix(no_na.test2$SMI)
Ylgdp.test<-as.matrix(no_na.testloggdp2$logGDPPC)

pov.xgb.dtrain = xgb.DMatrix(data = Xdata.train, label = Ypov.train)
pov.xgb.dtest = xgb.DMatrix(data =Xdata.test, label = Ypov.test)

lgdp.xgb.dtrain = xgb.DMatrix(data = Xdata.train, label = Ylgdp.train)
lgdp.xgb.dtest = xgb.DMatrix(data =Xdata.test, label = Ylgdp.test)

smi.xgb.dtrain = xgb.DMatrix(data = Xdata.train, label = Ysmi.train)
smi.xgb.dtest = xgb.DMatrix(data =Xdata.test, label = Ysmi.test)

params<-list(
  objective = "reg:squarederror", 
  eval_metric = "rmse",
  max_depth = 3,
  eta = 0.1
)

smi.xgb <- xgb.train(
  params = params, 
  data = smi.xgb.dtrain, 
  nrounds = 100, 
  watchlist = list(val = smi.xgb.dtest, train = smi.xgb.dtrain),
  early_stopping_rounds = 5, 
  verbose = 1
)

lgdp.xgb <- xgb.train(
  params = params, 
  data = lgdp.xgb.dtrain, 
  nrounds = 100, 
  watchlist = list(val = lgdp.xgb.dtest, train = lgdp.xgb.dtrain),
  early_stopping_rounds = 5, 
  verbose = 1
)

pov.xgb <- xgb.train(
  params = params, 
  data = pov.xgb.dtrain, 
  nrounds = 100, 
  watchlist = list(val = pov.xgb.dtest, train = pov.xgb.dtrain),
  early_stopping_rounds = 5, 
  verbose = 1
)

#xgb
smi.xgb.p <- predict(smi.xgb, smi.xgb.dtest) 
lgdp.xgb.p <- predict(lgdp.xgb, lgdp.xgb.dtest) 
pov.xgb.p <- predict(pov.xgb, pov.xgb.dtest)

#xgb
smi.xgb.mse <- mean((c.data.test2$`Social Mobility Index` - smi.xgb.p)^2) 
lgdp.xgb.mse <- mean((no_na.testloggdp2$logGDPPC - lgdp.xgb.p)^2) 
pov.xgb.mse <- mean((c.data.test2$`Poverty Rate` - pov.xgb.p)^2) 

c(smi.xgb.mse,lgdp.xgb.mse,pov.xgb.mse)

```



## TRAINING ERROR:

```{r}

#predicted values
#lm
smi.lm.p <- predict(lm_smi, c.data.test2) 
gdp.lm.p <- predict(lm_GDP, c.data.test2) 
pov.lm.p <- predict(lm_pov, c.data.test2) 
gdp.lm.p2 <- predict(lm_GDP2, c.data.test2)
#lasso
smi.lasso.p <- predict(lasso_smi, model.matrix(`Social Mobility Index`~.,data = no_na.test)[,-1]) # done
gdp.lasso.p <- predict(lasso_gdp, model.matrix(`GDP Per Capita`~.,data = no_na.test)[,-1]) # done but acc model doesnt exist
pov.lasso.p <- predict(lasso_pov, model.matrix(`Poverty Rate`~.,data = no_na.test)[,-1]) # done
#relaxed lasso
smi.rlasso.p <- predict(relaxed_lasso_smi, c.data.test2) # done
gdp.rlasso.p <- predict(relaxed_lasso_gdp, c.data.test2) # done but acc model doesnt exist
pov.rlasso.p <- predict(relaxed_lasso_pov, c.data.test2) # done
#trees
smi.tree.p <- predict(smi.fit_tree1, c.data.test2) # done
gdp.tree.p <- predict(gdp.fit_tree1, c.data.test2) # done
pov.tree.p <- predict(pov.fit_tree1, c.data.test2) # done
#random forests
smi.rf.p <- predict(rf_smi, no_na.test2) # done but acc model doesnt exist
gdp.rf.p <- predict(rf_gdp, no_na.test2) # done but acc model doesnt exist
pov.rf.p <- predict(rf_pov, no_na.test2) # done but acc model doesnt exist

#mse values
#lm
smi.lm.mse <- mean((c.data.test2$`Social Mobility Index` - smi.lm.p)^2) # done
gdp.lm.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.lm.p)^2) # done
pov.lm.mse <- mean((c.data.test2$`Poverty Rate` - pov.lm.p)^2) # done
gdp.lm.mse2 <- mean((c.data.test2$`GDP Per Capita` - gdp.lm.p2)^2)
#lasso
smi.lasso.mse <- mean((c.data.test2$`Social Mobility Index` - smi.lasso.p)^2) 
gdp.lasso.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.lasso.p)^2) 
pov.lasso.mse <- mean((c.data.test2$`Poverty Rate` - pov.lasso.p)^2) 
#relaxed lasso
smi.rlasso.mse <- mean((c.data.test2$`Social Mobility Index` - smi.rlasso.p)^2) 
gdp.rlasso.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.rlasso.p)^2) 
pov.rlasso.mse <- mean((c.data.test2$`Poverty Rate` - pov.rlasso.p)^2) 
#trees
smi.tree.mse <- mean((c.data.test2$`Social Mobility Index` - smi.tree.p)^2) 
gdp.tree.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.tree.p)^2) 
pov.tree.mse <- mean((c.data.test2$`Poverty Rate` - pov.tree.p)^2) 
#random forests
smi.rf.mse <- mean((c.data.test2$`Social Mobility Index` - smi.rf.p)^2) 
gdp.rf.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.rf.p)^2) 
pov.rf.mse <- mean((c.data.test2$`Poverty Rate` - pov.rf.p)^2) 


#dataframe mse by smi gdp and pov
smi.mse<-data.frame(smi.lm.mse, smi.lasso.mse, smi.rlasso.mse, smi.tree.mse, smi.rf.mse, smi.xgb.mse)
gdp.mse<-data.frame(gdp.lm.mse, gdp.lasso.mse, gdp.rlasso.mse, gdp.tree.mse, gdp.rf.mse, gdp.xgb.mse)
pov.mse<-data.frame(pov.lm.mse, pov.lasso.mse, pov.rlasso.mse, pov.tree.mse, pov.rf.mse, pov.xgb.mse)

smi.mse
gdp.mse
pov.mse
log.gdp.mse
exp(log.gdp.mse) * 1000


```
## Ensemble


```{r}
#ensemble prediction and mse by smi gdp and pov
#smi
smi.ensemble.pred <- (smi.lm.p+smi.lasso.p+smi.rlasso.p+smi.tree.p+smi.rf.p)/5
smi.ensemble.mse<- mean((smi.ensemble.pred-c.data.test2$`Social Mobility Index`)^2)
#gdp
gdp.ensemble.pred <- (gdp.lm.p+gdp.lasso.p+gdp.rlasso.p+gdp.tree.p+gdp.rf.p)/5
gdp.ensemble.mse<- mean((gdp.ensemble.pred-c.data.test2$`GDP Per Capita`)^2)
#pov
pov.ensemble.pred <- (pov.lm.p+pov.lasso.p+pov.rlasso.p+pov.tree.p+pov.rf.p)/5
pov.ensemble.mse<- mean((pov.ensemble.pred-c.data.test2$`Poverty Rate`)^2)


smi.ensemble.mse
gdp.ensemble.mse
pov.ensemble.mse

```

# PREDICTION

**CHOSEN MODELS**
Social Mobility Index: Linear Model
```{r, echo=FALSE}
summary(lm_smi)
plot(lm_smi)
```

Poverty Rate: Linear Model
```{r, echo=FALSE}
summary(lm_pov)
plot(lm_pov)
```

```{r}
library(ggplot2)
library(broom)
create_plots <- function(model) {
  # Use broom's augment to get residuals and fitted values
  augmented_data <- augment(model)
  
  # QQ plot
  qq_plot <- ggplot(augmented_data, aes(sample = .resid)) + 
    stat_qq(shape = 21, fill = "#FAFAFAFF", color = "#2C5F8D", size = 2.5, stroke = 1) +
    stat_qq_line(linetype = "dashed", color = "#2C5F8D", size =0.5) +
    ggtitle("QQ Plot") + xlab("Standardized Residuals") + ylab("Theoretical Quantiles")+
    theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA), # Light gray background
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1), # Dark blue border
    panel.grid.major = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.grid.minor = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1), # Dark blue border
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.background = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.box.background = element_blank(), # Remove the box around the legends
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D")
  )
  
  # Residuals vs Fitted values plot
  residual_plot <- ggplot(augmented_data, aes(x = .fitted, y = .resid)) +
  geom_point(shape = 21, fill = "#FAFAFAFF", color = "#2C5F8D", size = 2.5, stroke = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#2C5F8D") +
  geom_smooth(method = "loess", span = 10, se = FALSE, color = "#cfdee7") +
  ggtitle("Residuals vs Fitted Values") +
  xlab("Fitted Values") +
  ylab("Residuals") +
  theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA),
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1),
    panel.grid.major = element_line(color = "#d0ddeb"),
    panel.grid.minor = element_line(color = "#d0ddeb"),
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1),
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.background = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.box.background = element_blank(),
    legend.key = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D")
  )
  
  return(list(qq_plot = qq_plot, residual_plot = residual_plot))
}

lm_smi<-lm(`Social Mobility Index`~ `Wealth Share Top 1%`+`Gini Coefficient` +`Corruption Perception` , c.data.notest2)
summary(lm_smi)
relaxed_lasso_log_gdp <- lm(`logGDPPC` ~ `Corruption Perception`, no_na.notestloggdp)
smi_plots <- create_plots(lm_smi)
pov_plots<-create_plots(lm_pov)
gdp_plots <-create_plots(relaxed_lasso_log_gdp)
# 
print(smi_plots$qq_plot)
print(smi_plots$residual_plot)
# 
print(pov_plots$qq_plot)
print(pov_plots$residual_plot)

print(gdp_plots$qq_plot)
print(gdp_plots$residual_plot)

# plot(relaxed_lasso_log_gdp,1)
# 
# par(bg = "#FAFAFAFF", col.axis = "#2C5F8D", col.lab = "#2C5F8D", col.main = "#2C5F8D", col.sub = "#2C5F8D")
# 
# # Plot with custom parameters
# plot(relaxed_lasso_gdp,bg = "#FAFAFAFF",col = "#2C5F8D", col.axis = "#2C5F8D", col.lab = "#2C5F8D", col.main = "#2C5F8D", col.sub = "#2C5F8D",1)
# plot(relaxed_lasso_gdp)
# # Reset to default parameters
# par(mfrow = c(1, 1))

```
```{r}
relaxed_lasso_log_gdp <- lm(`logGDPPC` ~ `Corruption Perception`, no_na.notestloggdp)
# Sample data

# Set graphical parameters
par(
  bg = "#FAFAFAFF", # Light gray background
  col.axis = "#2C5F8D", # Dark blue for axis text
  col.lab = "#2C5F8D", # Dark blue for axis labels
  col.main = "#2C5F8D", # Dark blue for title
  col.sub = "#2C5F8D", # Dark blue for subtitle
  cex.lab = 1, # Axis label size
  cex.axis = 0.8, # Axis text size
  lwd = 2, # Line width for box and axis lines
  fg = "#2C5F8D" # Dark blue border around the plot area
)

# Plot with custom parameters
# plot(
#   relaxed_lasso_log_gdp,
#   main = "Residuals vs Fitted Values",
#   xlab = "Fitted Values",
#   ylab = "Residuals",
#   pch = 16, # Plotting character (solid circles)
#   col = "#2C5F8D", # Color for points
#   bg = "#FAFAFAFF", # Background color for plot area
#   panel.first = grid()
# )
plot(relaxed_lasso_log_gdp, 1, col = "#2C5F8D", # Color for points
  bg = "#FAFAFAFF",
  col.axis = "#2C5F8D", # Dark blue for axis text
  col.lab = "#2C5F8D", # Dark blue for axis labels
  col.main = "#2C5F8D", # Dark blue for title
  col.sub = "#2C5F8D", # Dark blue for subtitle
  cex.lab = 1, # Axis label size
  cex.axis = 0.8, # Axis text size
  lwd = 2, # Line width for box and axis lines
  fg = "#2C5F8D") # Dark blue border around the plot area)

# Add grid lines (similar to ggplot2's grid lines)
grid(col = "#d0ddeb", lty = 1) # Light gray grid lines

# Add border around the plot area (using rect)
rect(
  par("usr")[1], par("usr")[3], # Bottom-left corner of the plot area
  par("usr")[2], par("usr")[4], # Top-right corner of the plot area
  border = "#2C5F8D", # Dark blue border
  lwd = 2 # Line width
)




```

```{r}
plot(
  relaxed_lasso_log_gdp,1,           # X-axis values (first column# Y-axis values (second column)                       # Plot type as lines
  col = "#2C5F8D",                     # Line color (dark blue)
  bg = "#FAFAFAFF",                    # Background color for the plot area
  col.axis = "#2C5F8D",                # Dark blue for axis text
  col.lab = "#2C5F8D",                 # Dark blue for axis labels
  col.main = "#2C5F8D",                # Dark blue for title
  col.sub = "#2C5F8D",                 # Dark blue for subtitle
  cex.lab = 1,                         # Axis label size
  cex.axis = 0.8,                      # Axis text size
  lwd = 2,                             # Line width for lines
  fg = "#2C5F8D"                       # Dark blue border around the plot area
)

# Add grid lines (similar to ggplot2's grid lines)
grid(col = "#d0ddeb", lty = 1)        # Light gray grid lines

# Add border around the plot area (using rect)
rect(
  par("usr")[1], par("usr")[3],      # Bottom-left corner of the plot area
  par("usr")[2], par("usr")[4],      # Top-right corner of the plot area
  border = "#2C5F8D",                # Dark blue border
  lwd = 2                            # Line width
)
```

GDP Per Capita: 

america_base <- refined_country_data[27,]

america1 <- america_base %>%
  mutate(`Education Index`)
  
```


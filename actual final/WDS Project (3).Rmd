---
title: "The Collapse of the American Dream: 
*From Rags to Riches to The Ragged and The Rich*"
author: 
- John Wu
- Connie Lu
- Smriti Vijay
- Gwyneth Gao
- Alvin Li
output:
  html_document:
    df_print: paged
  ioslides_presentation: default
  slidy_presentation: default
  beamer_presentation:
    slide_level: 3
    theme: Boadilla
always_allow_html: true
header-includes:
- \AtBeginSection[]{\begin{frame}\tableofcontents[currentsection]\end{frame}}
- \AtBeginSubsection[]{\begin{frame}\tableofcontents[currentsubsection]\end{frame}{}}
editor_options:
  chunk_output_type: inline
  knitr:
  opts_chunk:
    echo: FALSE
    results: "hide"
    message: FALSE
    warning: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(tidyverse, readxl, ggrepel, car, glmnet, randomForest, rpart, rpart.plot, xgboost, mapdata)
# library(tidyverse)
# library(readxl)
# library(ggrepel)
# library(car)
# library(glmnet)
# library(randomForest)
# library(rpart)
# library(rpart.plot)
# library(xgboost)
```

# EDA

## Importing All Excel Sheets

```{r, echo=FALSE, warning=F, message=F}
country_tuition <- (read_excel("data/WDS Project.xlsx"))
country_tuition <- country_tuition %>%
  mutate(`Tuition Fees in USD Thousands` = `Tuition Fees in USD` / 1000) %>%
  mutate(`Tuition Fees in USD Thousands less 0` = na_if(`Tuition Fees in USD Thousands`, 0)) %>%
  select(-'Cost of One Year at University(â‚¬)', -`Tuition Fees in USD`, -`Tuition Fees in USD Thousands`) 
  

health_index <- (read_excel("data/WDS Project.xlsx", sheet = "Health Index Country"))

education_index <- (read_excel("data/WDS Project.xlsx", sheet = "Education Index"))
education_index <- education_index %>%
  rename('Education Index' = '2021 Education Index')

top_1_share_country <- (read_excel("data/WDS Project.xlsx", sheet = "Country 1% Share"))
top_1_share_country <- top_1_share_country %>%
  rename('Wealth Share Top 1%' = '% of income of the richest 1%') %>%
  mutate('Wealth Share Top 1%' = `Wealth Share Top 1%` * 100)

welfare_country <- (read_excel("data/WDS Project.xlsx", sheet = "Country Social GDP"))
welfare_country  <- welfare_country %>%
  rename('Welfare Spending % GDP' = 'Social Welfare Spending as % of GDP - 2019') 

gini_country <- (read_excel("data/WDS Project.xlsx", sheet = "Gini Country"))

mobility_index <- (read_excel("data/WDS Project.xlsx", sheet = "Global Social Mobility Index")) 
mobility_index <- mobility_index %>%
  rename('Social Mobility Index' = 'Index Score') %>%
  select(-'Rank')

house_affordability_country <- (read_excel('data/WDS Project.xlsx', sheet = 'House Affordability Index'))
house_affordability_country <- house_affordability_country %>%
  mutate('Affordable Housing' = ifelse(`Mortgage as a % of Income` <= 1, 1, 0))

corruption_index <- (read_excel('data/WDS Project.xlsx', sheet = 'Corruption Country'))

corruption_index <- corruption_index %>%
  rename('Corruption Perception' = 'CPI Score - 2023')

universal_healthcare <- (read_excel('data/WDS Project.xlsx', sheet = 'Universal Healthcare'))

poverty_rate <- (read_excel('data/WDS Project.xlsx', sheet = 'Country Poverty'))

GDP_country <- (read_excel('data/WDS Project.xlsx', sheet = 'GDP Country'))
GDP_country <- GDP_country 
 # mutate(`GDP Per Capita` = `GDP Per Capita` / 1000)




```


```{r, echo = F, results = 'hide'}
#importing medicare prem
medicare_prem <- (read_excel("data/WDS Project.xlsx", sheet = 'Medicare Premiums'))
#cleaning up medicare prem
medicare_prem <- medicare_prem %>%
  select(-'Standard Monthly Premium (Before Income Adjustments)', - 'Value in 2024 Dollars')

#importing US house price index
house_price_us <- (read_excel("data/WDS Project.xlsx", sheet = 'US House Price Index'))
#cleaning up US house price index
house_price_us <- house_price_us %>%
   rename('House Price Index' = 'House Price Index - Real Dollars') %>%
  select(Year, `House Price Index`)

#importing tuition
tuition_us <- (read_excel("data/WDS Project.xlsx", sheet = 'Tuition v Time'))
#cleaning up tuition
tuition_us <- tuition_us %>%
  select(-'Total tuition, fees, room, and board - All Institutions (Public & Private) - Nominal Dollars', - 'Total tuition, fees, room, and board - All Institutions (Public & Private) - 2022 Dollars')

#importing child surpass
child_surpass_us <- (read_excel("data/WDS Project.xlsx", sheet = 'P( Children Inc. Surpass Fath)'))
#cleaning up child surpass
child_surpass_us <- child_surpass_us %>%
   rename('fs_p25' = 'abs_mob_pos_par_fs_ind_p25' , 'fs_p50' =  'abs_mob_pos_par_fs_ind_p50', 'fs_p75' =  'abs_mob_pos_par_fs_ind_p75' ,  'fd_p25' = 'abs_mob_pos_par_fd_ind_p25', 'fd_p50' = 'abs_mob_pos_par_fd_ind_p50', 'fd_p75' = 'abs_mob_pos_par_fd_ind_p75')

#importing median income
med_income_us <- (read_excel("data/WDS Project.xlsx", sheet = 'Median Income Time'))
#cleaning up median income
med_income_us <- med_income_us %>%
   select(-'Real Median Income')

#importing personal savings rate
save_rate <- (read_excel("data/WDS Project.xlsx", sheet = 'Save Rate Time'))

#importing gini
gini_us <- (read_excel("data/WDS Project.xlsx", sheet = 'Gini Time'))

#importing share of wealth owned by certain percentage
wealth_share_us<- (read_excel("data/WDS Project.xlsx", sheet = 'Time Wealth Share'))
#cleaning up  share of wealth owned by certain percentage
wealth_share_us <- wealth_share_us %>%
   rename('Wealth of lower 50%' = 'Share of Total Wealth Owned by Lowest 50%', 'Wealth of top 1%' = 'Share of Total Wealth Owned by Top 1%')

```


## JOINING DATA
```{r, results='hide', echo=F}
country_data <- (mobility_index %>%
  full_join(health_index, by = 'Country') %>%
  full_join(education_index, by = 'Country') %>%
  full_join(top_1_share_country, by = 'Country') %>%
  full_join(welfare_country, by ='Country') %>%
  full_join(gini_country, by = 'Country') %>%
  full_join(country_tuition, by = 'Country') %>%
  full_join(house_affordability_country, by = 'Country') %>%
  full_join(corruption_index, by = 'Country') %>%
  full_join(universal_healthcare, by='Country') %>%
  full_join(GDP_country, by='Country') %>%
  full_join(poverty_rate, by='Country'))[1:82,]


country_data <- country_data %>%
  mutate(`Universal Healthcare` = ifelse(is.na(`Universal Healthcare`), 'No', `Universal Healthcare`)) %>%
  mutate(`Universal Healthcare` = factor(`Universal Healthcare`)) %>%
  mutate(`Affordable Housing` = ifelse(`Affordable Housing` == 1, 'Yes', 'No')) %>%
  mutate(`Affordable Housing` = factor(`Affordable Housing`)) %>%
  select(-GDP)

refined_country_data <- country_data %>%
  select(-`Universal Healthcare`, - Country, -`Tuition Fees in USD Thousands less 0`, - `% of World GDP`, -`Affordable Housing`, -`Housing Affordability Index`)



expenditures <- medicare_prem %>%
  full_join(house_price_us, by = 'Year') %>%
  full_join(tuition_us, by = 'Year') %>%
  full_join(med_income_us, by = 'Year') %>%
  select(`Year`, `Healthcare Premium Index`, `House Price Index`, `Tuition Index`, `Median Income Index`)

expenditures_data_long <- expenditures %>%
  pivot_longer(cols= - Year, names_to ='Expenditures', values_to = 'Values')


surpass_data_long <- child_surpass_us %>%
  pivot_longer(cols = - Year, names_to = "Groups", values_to = "Percent")

wealth_share_long <- wealth_share_us %>%
  pivot_longer(cols= -Year, names_to = 'Groups', values_to = 'Percent')

fituniversal <- lm(`Social Mobility Index` ~ `Universal Healthcare` + `Affordable Housing`, country_data)
summary(fituniversal)

```

## Visualizing

```{r, echo=F, results=F}
ggplot(expenditures_data_long, aes(x=Year, y=Values, col=Expenditures)) +
  geom_smooth(se=F)+ theme_bw() +
   labs(
    title = "Expenditures (CPI-Adjusted, Indexed to 1984)")
    #fill = "Highlight Status", # Legend title
    # x-axis label
     # y-axis label
ggplot(surpass_data_long, aes(x=Year, y= Percent, col = Groups)) +
  geom_smooth(se=F)  + theme_bw() +
   labs(
    title = "Percent of Children Surpassing Father's Income", 
    x = 'Year Children Born In')
    #fill = "Highlight Status", # Legend title
    # x-axis label
     # y-axis label
ggplot(gini_us, aes(x=Year, y=`Gini Coefficient`)) +
   geom_rect(aes(xmin = 1980 - 0.5, xmax = 1980 + 9, ymin = -Inf, ymax = Inf),
            fill = "grey80", alpha = 0.5) +
  annotate("text", x = 1980, y = max(country_data$Value) * 0.9, 
           label = "Reaganomics Implementation", angle = 0, vjust = -30, hjust = 1) +
   geom_smooth(se=F) + theme_bw()
ggplot(wealth_share_long, aes(x=Year, y=Percent)) +
   geom_rect(aes(xmin = 1980 - 0.5, xmax = 1980 + 9, ymin = -Inf, ymax = Inf),
            fill = "grey80", alpha = 0.5) +
  annotate("text", x = 1980, y = max(country_data$Value) * 0.9, 
           label = "Reaganomics Implementation", angle = 0, vjust = -15, hjust = -0.5) +
  geom_smooth(aes(col=Groups),se=F) + theme_bw()

ggplot(save_rate, aes(x=Year, y=`Personal Savings Rate`)) +
  xlim(1975, 2024) +
  ylim(2,20) +
  geom_rect(aes(xmin = 2020-2, xmax = 2022, ymin = -Inf, ymax = Inf),
            fill = "grey80", alpha = 0.5) +
  annotate("text", x = 2020, y = max(country_data$Value) * 0.9, 
           label = "COVID-19", angle = 0, vjust = -25, hjust = 1.5) +
  geom_point(col='darkblue') + theme_bw()

```


## PLOTTING

```{r, echo=F, results='hide'}
summary(country_data)
dim(country_data)

## Testing for Correlation


ggplot(country_data, aes(x=`Education Index`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Gini Coefficient`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Health Care Index`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Health Expenditure Index`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Wealth Share Top 1%`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Welfare Spending % GDP`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Tuition Fees in USD Thousands less 0`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Housing Affordability Index`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Mortgage as a % of Income`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Price to Income Ratio`, y=`Social Mobility Index`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(country_data, aes(x=`Corruption Perception`, y=`Social Mobility Index`)) +
  geom_smooth(se=F) + theme_bw()
ggplot(country_data, aes(y=`Social Mobility Index`, x=`Affordable Housing`)) +
  geom_point(aes(color = factor(`Affordable Housing`))) +
  geom_smooth(method= 'glm', method.args = list(family = 'binomial'), se = F)+ theme_bw()
ggplot(refined_country_data, aes(x=`Social Mobility Index`, y=`Poverty Rate`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(refined_country_data, aes(x=`Gini Coefficient`, y=`Poverty Rate`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(refined_country_data, aes(x=`Education Index`, y=`Poverty Rate`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(refined_country_data, aes(x=`Social Mobility Index`, y=`GDP Per Capita`)) +
  geom_smooth(se=F)+ theme_bw()
ggplot(refined_country_data, aes(x=`Education Index`, y=`GDP Per Capita`)) +
  geom_smooth(se=F)+ theme_bw()

# ggplot(refined_country_data, aes(x=`Housing Affordability Index`, y=`Poverty Rate`)) +
# geom_smooth(se=F)+ theme_bw()

ggplot(refined_country_data, aes(x=`Mortgage as a % of Income`, y=`Poverty Rate`)) +
geom_smooth(se=F)+ theme_bw()
ggplot(refined_country_data, aes(y=`GDP Per Capita`, x=`Poverty Rate`)) +
geom_smooth(se=F)+ theme_bw()

ggplot(refined_country_data, aes(x=`Gini Coefficient`, y=`GDP Per Capita`)) +
geom_smooth(se=F)+ theme_bw()

ggplot(refined_country_data, aes(x=`Welfare Spending % GDP`, y=`GDP Per Capita`)) +
geom_smooth(se=F) + theme_bw()

ggplot(refined_country_data, aes(x=`Health Care Index`, y=`GDP Per Capita`)) +
geom_smooth(se=F)+ theme_bw()

```


# Data Preparation


```{r, warning=FALSE, message=FALSE, echo=FALSE}

set.seed(123)

refined_country_data <- refined_country_data %>%
  mutate(`GDP Per Capita` = `GDP Per Capita` / 1000)

no_na.countryinc <- country_data[complete.cases(country_data), ]

no_na <- refined_country_data[complete.cases(refined_country_data), ] %>%
  select(-Rank) 



testing_indices2 <- sample(nrow(no_na), 5)

c.data.test2 <- no_na[testing_indices2, ]

no_na.notest <- no_na[-testing_indices2,] 
 
no_na.test <- no_na[testing_indices2, ] 

test_rows <- which(row.names(refined_country_data) %in% row.names(c.data.test2))

c.data.notest2 <- refined_country_data[-test_rows, ] %>%
  select(-Rank)


```

# Data Analysis 

## LM, LASSO, & RELAXED LASSO


```{r, warning=FALSE, message=FALSE, echo=FALSE}

predictors <- no_na.notest %>%
  select(-`Social Mobility Index`)
predictors <- model.matrix(~., data=predictors)[,-1]


lasso_smi <- cv.glmnet(predictors, no_na.notest$`Social Mobility Index`, alpha=1)
coef(lasso_smi, s= 'lambda.min')

relaxed_lasso_smi <- lm(`Social Mobility Index` ~ `Health Expenditure Index` + `Wealth Share Top 1%` + `Gini Coefficient` + `Corruption Perception`, c.data.notest2)
summary(relaxed_lasso_smi)

# lm_smi <- lm(`Social Mobility Index` ~ `Education Index` +`Wealth Share Top 1%` + `Welfare Spending % GDP` + `Corruption Perception` + `Health Care Index` + `Housing Affordability Index`, data=refined_country_data)
# summary(lm_smi)

lm_smi<-lm(`Social Mobility Index`~.-`Poverty Rate`-`GDP Per Capita`-`Welfare Spending % GDP`-`Mortgage as a % of Income`-`Price to Income Ratio`-`Education Index`-`Health Care Index` -`Health Expenditure Index` , data = c.data.notest2)
summary(lm_smi)


# POVERTY

predictorspov <- no_na.notest %>%
  select(-`Poverty Rate`)
predictorspov <- model.matrix(~., data=predictorspov)[,-1]

lasso_pov <- cv.glmnet(predictorspov, no_na.notest$`Poverty Rate`, alpha=1)

coef(lasso_pov, s='lambda.min')

relaxed_lasso_pov <- lm(`Poverty Rate` ~ `Welfare Spending % GDP` + `Gini Coefficient`, data=c.data.notest2)

summary(relaxed_lasso_pov)



# lm_pov <- lm(`Poverty Rate` ~ . - `Social Mobility Index` - `GDP Per Capita` , data=c.data.notest2)
# summary(lm_pov)

lm_pov <- lm(`Poverty Rate` ~. - `Social Mobility Index` - `GDP Per Capita` - `Education Index` - `Health Expenditure Index` - `Price to Income Ratio` - `Gini Coefficient` - `Mortgage as a % of Income` - `Corruption Perception`, c.data.notest2)
summary(lm_pov)


# lm_pov2 <- lm(`Poverty Rate` ~. - `Social Mobility Index` - `GDP Per Capita` - `Health Expenditure Index` - `Price to Income Ratio` - `Gini Coefficient`, c.data.notest2)
# summary(lm_pov2)

# GDP
# predictorsgdp <- no_na.notest %>%
#   select(-`GDP Per Capita`)
# predictorsgdp <- model.matrix(~., data=predictorsgdp)[,-1]
# 
# lasso_gdp <- cv.glmnet(predictorsgdp, no_na.notest$`GDP Per Capita`, alpha=1)
# coef(lasso_gdp)
# 
# relaxed_lasso_gdp <- lm(`GDP Per Capita` ~ `Education Index` + `Corruption Perception`, c.data.notest2)
# summary(relaxed_lasso_gdp)
# 
# 
# lm_GDP <- lm(`GDP Per Capita` ~ . - `Mortgage as a % of Income` - `% of World GDP` - `Social Mobility Index` - `Education Index` - `Welfare Spending % GDP` - `Health Expenditure Index` - `Affordable Housing` - `Wealth Share Top 1%` -`Poverty Rate`, c.data.notest2)
# summary(lm_GDP)
# 
# lm_GDP2 <- lm(`GDP Per Capita` ~ `Social Mobility Index` + `Education Index` + `Poverty Rate` + `Gini Coefficient`, c.data.notest2)
# summary(lm_GDP2)

```

# testing log GDP

```{r, warning=FALSE, message=FALSE, echo=FALSE}

c.data.notestlogGDP <- c.data.notest2 %>%
  mutate(logGDPPC = log(`GDP Per Capita`)) %>%
  select(-`GDP Per Capita`)


c.data.testlogGDP <- c.data.test2 %>%
  mutate(logGDPPC = log(`GDP Per Capita`)) %>%
  select(-`GDP Per Capita`)

lm_log_GDP <- lm(`logGDPPC` ~. - `Social Mobility Index` - `Poverty Rate`, c.data.notestlogGDP)
summary(lm_log_GDP)
log.gdp.lm.p <- predict(lm_log_GDP, c.data.testlogGDP)
log.gdp.lm.mse <- mean((c.data.testlogGDP$`logGDPPC` - log.gdp.lm.p)^2)
exp(log.gdp.lm.mse)


predictorsgdp <- no_na.notest %>%
  select(-`GDP Per Capita`)
predictorsgdp <- model.matrix(~., data=predictorsgdp)[,-1]

no_na.notestloggdp <- no_na.notest %>%
  mutate(logGDPPC = log(`GDP Per Capita`)) %>%
  select(-`GDP Per Capita`)

no_na.testloggdp <- no_na.test %>%
  mutate(logGDPPC = log(`GDP Per Capita`)) %>%
  select(-`GDP Per Capita`)

lasso_log_gdp <- cv.glmnet(predictorsgdp, no_na.notestloggdp$logGDPPC, alpha=1)
coef(lasso_log_gdp, s='lambda.min')
plot(lasso_log_gdp)

log.gdp.lasso.p <- predict(lasso_log_gdp, model.matrix(`logGDPPC`~.,data = no_na.testloggdp)[,-1]) 

log.gdp.lasso.mse <- mean((c.data.testlogGDP$`logGDPPC` - log.gdp.lasso.p)^2)
1000*exp(log.gdp.lasso.mse)

relaxed_lasso_log_gdp <- lm(`logGDPPC` ~ `Corruption Perception`, no_na.notestloggdp)
summary(relaxed_lasso_log_gdp)
log.gdp.relaxed.lm.p <- predict(relaxed_lasso_log_gdp, c.data.testlogGDP)
log.gdp.relaxed.lm.mse <- mean((c.data.testlogGDP$`logGDPPC` - log.gdp.relaxed.lm.p)^2)
exp(log.gdp.relaxed.lm.mse) * 1000


log.gdp.fit_tree <- rpart(`logGDPPC`~., data = no_na.notestloggdp %>% select(-`Social Mobility Index`, -`Poverty Rate`), control=rpart.control(minsplit=2, cp=0.01))
rpart.plot(log.gdp.fit_tree)
log.gdp.tree.p <- predict(log.gdp.fit_tree, no_na.testloggdp)
log.gdp.tree.mse <- mean((no_na.testloggdp$logGDPPC - log.gdp.tree.p)^2)
exp(log.gdp.tree.mse) * 1000

new_names2 <- c('SMI', 'HCI', 'HEI', 'EI', 'WST1', 'WSGDP', 'GINI', 'MPI', 'PIR', 'CP', 'PR', 'GDPPC' )

no_na.notestloggdp2 <- no_na.notestloggdp %>%
  rename_with(~new_names2) %>%
  rename(logGDPPC = GDPPC)

no_na.testloggdp2 <- no_na.testloggdp %>%
  rename_with(~new_names2) %>%
  rename(logGDPPC = GDPPC)


log.gdp.error.p <- 1:16 # set up a vector of length 16
for (p in 1:16) # repeat the following code inside { } 16 times
{
forest.log.gdp <- randomForest(`logGDPPC`~., no_na.notestloggdp2 %>% select(-PR, - SMI), mtry=p, ntree=250)
log.gdp.error.p[p] <- forest.log.gdp$mse[250] # collecting oob mse based on 250 trees
}
plot(1:16, log.gdp.error.p)
rf_log_gdp <- randomForest(logGDPPC~ . ,data=no_na.notestloggdp2 %>% select(-PR, -SMI), mtry=10, ntree=100)
rf_log_gdp.p <- predict(rf_log_gdp, no_na.testloggdp2)
rf_log_gdp.mse <- mean((no_na.testloggdp2$logGDPPC - rf_log_gdp.p)^2)
exp(rf_log_gdp.mse) * 1000


# 
# ggplot(no_na.notestloggdp2, aes(x=CP, y=logGDPPC)) +
#   geom_smooth(se=F)

```


## TREE
```{r, warning=FALSE, message=FALSE, echo=FALSE}
smi.fit_tree1 <- rpart(`Social Mobility Index`~., data = no_na.notest %>% select(-`GDP Per Capita`,-`Poverty Rate`), control=rpart.control(minsplit=2, cp=0.01))
rpart.plot(smi.fit_tree1)


gdp.fit_tree1 <- rpart(`GDP Per Capita`~., data = no_na.notest %>% select(-`Social Mobility Index`, -`Poverty Rate`), control=rpart.control(minsplit=2, cp=0.01))
rpart.plot(gdp.fit_tree1)

pov.fit_tree1 <- rpart(`Poverty Rate` ~., data= no_na.notest %>% select(-`Social Mobility Index`, -`GDP Per Capita`), control=rpart.control(minsplit=2, cp=0.01))
rpart.plot(pov.fit_tree1)

```

## RANDOM FORESTS

```{r, warning=FALSE, message=FALSE, echo=FALSE}

new_names <- c('SMI', 'HCI', 'HEI', 'EI', 'WST1', 'WSGDP', 'GINI', 'MPI', 'PIR', 'CP', 'GDPPC', 'PR')

no_na.notest2 <- no_na.notest %>%
  rename_with(~new_names)
no_na.test2 <- no_na.test %>%
  rename_with(~new_names)

#mtry looping
smi.error.p <- 1:16 # set up a vector of length 16
for (p in 1:16) # repeat the following code inside { } 16 times
{
forest.smi <- randomForest(SMI~., no_na.notest2 %>% select(-GDPPC, -PR), mtry=p, ntree=250)
smi.error.p[p] <- forest.smi$mse[250] # collecting oob mse based on 250 trees
}
 # oob mse returned: should be a vector of 19
plot(1:16, smi.error.p)

rf_smi <- randomForest(SMI~ . ,data=no_na.notest2 %>% select(-GDPPC, -PR), mtry=6, ntree=100)


#mtry looping
pov.error.p <- 1:16 # set up a vector of length 16
for (p in 1:16) # repeat the following code inside { } 16 times
{
forest.pov <- randomForest(`PR`~., no_na.notest2 %>% select(-SMI, -GDPPC), mtry=p, ntree=250)
pov.error.p[p] <-forest.pov$mse[250] # collecting oob mse based on 250 trees
}

plot(1:16, pov.error.p)
rf_pov <- randomForest(PR~ . ,no_na.notest2 %>% select(-SMI, -GDPPC), mtry=6, ntree=100)


#mtry looping
gdp.error.p <- 1:16 # set up a vector of length 16
for (p in 1:16) # repeat the following code inside { } 16 times
{
forest.gdp <- randomForest(`GDPPC`~., no_na.notest2 %>% select(-SMI, -PR), mtry=p, ntree=250)
gdp.error.p[p] <- forest.gdp$mse[250] # collecting oob mse based on 250 trees
}
plot(1:16, gdp.error.p)
rf_gdp <- randomForest(GDPPC~ . ,data=no_na.notest2 %>% select(-SMI, -PR), mtry=11, ntree=100)


```

## XG Boost
```{r, echo=F, warning=F, message=F, include=F}


Xdata.train<-no_na.notest2%>%
  select(-PR,-SMI, -GDPPC)%>%as.matrix()
Ypov.train<-as.matrix(no_na.notest2$PR)
Ysmi.train<-as.matrix(no_na.notest2$SMI)
Ylgdp.train<-as.matrix(no_na.notestloggdp2$logGDPPC)

Xdata.test<-no_na.test2%>%
  select(-PR,-SMI, -GDPPC)%>%as.matrix()
Ypov.test<-as.matrix(no_na.test2$PR)
Ysmi.test<-as.matrix(no_na.test2$SMI)
Ylgdp.test<-as.matrix(no_na.testloggdp2$logGDPPC)

pov.xgb.dtrain = xgb.DMatrix(data = Xdata.train, label = Ypov.train)
pov.xgb.dtest = xgb.DMatrix(data =Xdata.test, label = Ypov.test)

lgdp.xgb.dtrain = xgb.DMatrix(data = Xdata.train, label = Ylgdp.train)
lgdp.xgb.dtest = xgb.DMatrix(data =Xdata.test, label = Ylgdp.test)

smi.xgb.dtrain = xgb.DMatrix(data = Xdata.train, label = Ysmi.train)
smi.xgb.dtest = xgb.DMatrix(data =Xdata.test, label = Ysmi.test)

params<-list(
  objective = "reg:squarederror", 
  eval_metric = "rmse",
  max_depth = 3,
  eta = 0.1
)

smi.xgb <- xgb.train(
  params = params, 
  data = smi.xgb.dtrain, 
  nrounds = 100, 
  watchlist = list(val = smi.xgb.dtest, train = smi.xgb.dtrain),
  early_stopping_rounds = 5, 
  verbose = 1
)

lgdp.xgb <- xgb.train(
  params = params, 
  data = lgdp.xgb.dtrain, 
  nrounds = 100, 
  watchlist = list(val = lgdp.xgb.dtest, train = lgdp.xgb.dtrain),
  early_stopping_rounds = 5, 
  verbose = 1
)

pov.xgb <- xgb.train(
  params = params, 
  data = pov.xgb.dtrain, 
  nrounds = 100, 
  watchlist = list(val = pov.xgb.dtest, train = pov.xgb.dtrain),
  early_stopping_rounds = 5, 
  verbose = 1
)

#xgb
smi.xgb.p <- predict(smi.xgb, smi.xgb.dtest) 
lgdp.xgb.p <- predict(lgdp.xgb, lgdp.xgb.dtest) 
pov.xgb.p <- predict(pov.xgb, pov.xgb.dtest)

#xgb
smi.xgb.mse <- mean((c.data.test2$`Social Mobility Index` - smi.xgb.p)^2) 
lgdp.xgb.mse <- mean((no_na.testloggdp2$logGDPPC - lgdp.xgb.p)^2) 
pov.xgb.mse <- mean((c.data.test2$`Poverty Rate` - pov.xgb.p)^2) 

c(smi.xgb.mse,lgdp.xgb.mse,pov.xgb.mse)

log.gdp.mse <- data.frame(log.gdp.lm.mse, log.gdp.lasso.mse, log.gdp.relaxed.lm.mse, log.gdp.tree.mse, rf_log_gdp.mse, lgdp.xgb.mse) %>%
  rename_with(~c('GDP.LM.MSE', 'GDP.LASSO.MSE', 'GDP.RLASSO.MSE', 'GDP.TREE.MSE', 'GDP.FOREST.MSE', 'GDP.XGB.MSE'))
log.gdp.mse
1000 * exp(log.gdp.mse)

```




## TRAINING ERROR:

```{r, warning=FALSE, message=FALSE, echo=FALSE}

#predicted values
#lm
smi.lm.p <- predict(lm_smi, c.data.test2) 
# gdp.lm.p <- predict(lm_GDP, c.data.test2) 
pov.lm.p <- predict(lm_pov, c.data.test2) 
# gdp.lm.p2 <- predict(lm_GDP2, c.data.test2)
#lasso

smi.lasso.p <- predict(lasso_smi, model.matrix(`Social Mobility Index`~., data=no_na.test)[,-1])
# gdp.lasso.p <- predict(lasso_gdp, model.matrix(`GDP Per Capita`~.,data = no_na.test)[,-1]) # done but acc model doesnt exist
pov.lasso.p <- predict(lasso_pov, model.matrix(`Poverty Rate`~.,data = no_na.test)[,-1]) # done
#relaxed lasso
smi.rlasso.p <- predict(relaxed_lasso_smi, c.data.test2) # done
#gdp.rlasso.p <- predict(relaxed_lasso_gdp, c.data.test2) # done but acc model doesnt exist
pov.rlasso.p <- predict(relaxed_lasso_pov, c.data.test2) # done
#trees
smi.tree.p <- predict(smi.fit_tree1, c.data.test2) # done
# gdp.tree.p <- predict(gdp.fit_tree1, c.data.test2) # done
pov.tree.p <- predict(pov.fit_tree1, c.data.test2) # done
#random forests
smi.rf.p <- predict(rf_smi, no_na.test2) # done but acc model doesnt exist
# gdp.rf.p <- predict(rf_gdp, no_na.test2) # done but acc model doesnt exist
pov.rf.p <- predict(rf_pov, no_na.test2) # done but acc model doesnt exist

#mse values
#lm
smi.lm.mse <- mean((c.data.test2$`Social Mobility Index` - smi.lm.p)^2) # done
# gdp.lm.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.lm.p)^2) # done
pov.lm.mse <- mean((c.data.test2$`Poverty Rate` - pov.lm.p)^2) # done
# gdp.lm.mse2 <- mean((c.data.test2$`GDP Per Capita` - gdp.lm.p2)^2)
#lasso
smi.lasso.mse <- mean((c.data.test2$`Social Mobility Index` - smi.lasso.p)^2) 
# gdp.lasso.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.lasso.p)^2) 
pov.lasso.mse <- mean((c.data.test2$`Poverty Rate` - pov.lasso.p)^2) 
#relaxed lasso
smi.rlasso.mse <- mean((c.data.test2$`Social Mobility Index` - smi.rlasso.p)^2) 
# gdp.rlasso.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.rlasso.p)^2) 
pov.rlasso.mse <- mean((c.data.test2$`Poverty Rate` - pov.rlasso.p)^2) 
#trees
smi.tree.mse <- mean((c.data.test2$`Social Mobility Index` - smi.tree.p)^2) 
# gdp.tree.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.tree.p)^2) 
pov.tree.mse <- mean((c.data.test2$`Poverty Rate` - pov.tree.p)^2) 
#random forests
smi.rf.mse <- mean((c.data.test2$`Social Mobility Index` - smi.rf.p)^2) 
# gdp.rf.mse <- mean((c.data.test2$`GDP Per Capita` - gdp.rf.p)^2) 
pov.rf.mse <- mean((c.data.test2$`Poverty Rate` - pov.rf.p)^2) 


#dataframe mse by smi gdp and pov
smi.mse<-data.frame(smi.lm.mse, smi.lasso.mse, smi.rlasso.mse, smi.tree.mse, smi.rf.mse, smi.xgb.mse) %>% mutate_all(~round(.,2))
# gdp.mse<-data.frame(gdp.lm.mse, gdp.lasso.mse, gdp.rlasso.mse, gdp.tree.mse, gdp.rf.mse) %>%
  # mutate_all(~round(.,2))
pov.mse<-data.frame(pov.lm.mse, pov.lasso.mse, pov.rlasso.mse, pov.tree.mse, pov.rf.mse, pov.xgb.mse) %>% mutate_all(~round(.,2))


smi.mse
pov.mse
# log.gdp.mse
exp(log.gdp.mse) * 1000

smi.mse.long <- smi.mse %>%
  pivot_longer(cols = everything(), names_to = "model", values_to = "MSE")
ggplot(smi.mse.long, aes(x = model, y = MSE)) +
  geom_bar(stat = "identity", fill = "darkblue") +
  geom_text(aes(label = MSE), vjust = -0.5, color = "black") + # Add labels
  theme_minimal() +
  labs(title = "Bar Graph of MSE - SMI", x = "Model", y = "MSE")


pov.mse.long <- pov.mse %>%
  pivot_longer(cols = everything(), names_to = "model", values_to = "MSE")
ggplot(pov.mse.long, aes(x = model, y = MSE)) +
  geom_bar(stat = "identity", fill = "darkblue") +
  geom_text(aes(label = MSE), vjust = -0.5, color = "black") + # Add labels
  theme_minimal() +
  labs(title = "Bar Graph of MSE - POV", x = "Model", y = "MSE")

log.gdp.mse.long <- log.gdp.mse %>%
  pivot_longer(cols = everything(), names_to = "model", values_to = "MSE") %>%
  mutate(MSE = exp(MSE) * 1000) 
 # mutate_all(~round(.,2))
ggplot(log.gdp.mse.long, aes(x = model, y = MSE)) +
  geom_bar(stat = "identity", fill = "darkblue") +
  geom_text(aes(label = sprintf("%.2f", MSE)) , vjust = -0.5, color = "black") + # Add labels
  theme_minimal() +
  labs(title = "Bar Graph of MSE - GDP", x = "Model", y = "MSE")
```
## Ensemble


```{r, warning=F, echo=F, message=F}
#ensemble prediction and mse by smi gdp and pov
#smi
smi.ensemble.pred <- (smi.lm.p+smi.lasso.p+smi.rlasso.p+smi.tree.p+smi.rf.p)/5
smi.ensemble.mse<- mean((smi.ensemble.pred-c.data.test2$`Social Mobility Index`)^2)
#gdp
# gdp.ensemble.pred <- (gdp.lm.p+gdp.lasso.p+gdp.rlasso.p+gdp.tree.p+gdp.rf.p)/5
# gdp.ensemble.mse<- mean((gdp.ensemble.pred-c.data.test2$`GDP Per Capita`)^2)
#pov
pov.ensemble.pred <- (pov.lm.p+pov.lasso.p+pov.rlasso.p+pov.tree.p+pov.rf.p)/5
pov.ensemble.mse<- mean((pov.ensemble.pred-c.data.test2$`Poverty Rate`)^2)


smi.ensemble.mse
# gdp.ensemble.mse
pov.ensemble.mse

```

# PREDICTION MODELS

**CHOSEN MODELS**


Social Mobility Index: Linear Model
```{r, echo=FALSE, warning=F, message=F}
summary(lm_smi)
confint(lm_smi, level=.95)
plot(lm_smi, 1)
plot(lm_smi, 2)
```

Poverty Rate: Linear Model
```{r, echo=FALSE, warning=F, message=F}
summary(lm_pov)
confint(lm_pov)
plot(lm_pov, 1)
plot(lm_pov, 2)
```

GDP Per Capita: 
```{r, echo=FALSE, warning=F, message=F}
summary(relaxed_lasso_log_gdp)
confint(relaxed_lasso_log_gdp)
plot(lm_log_GDP, 1)
plot(lm_log_GDP, 2)

```




# PREDICTIONS

```{r}
america_base <- refined_country_data[27,]

america2 <- data.frame(
'Corruption Perception' = 90,
'Education Index' = 1.01,
'Health Care Index' = 86.4,
'Gini Coefficient' = 0.23,
'Housing Affordability Index' = 4.6,
'Wealth Share Top 1%' = 6.9,
'Welfare Spending % GDP' = 31.2,
'Price to Income Ratio' = 2.9,
'Health Expenditure Index' = 86, 
'Mortgage as a % of Income' = 86,
'GDP Per Capita' = 86,
'Poverty Rate' = 86,
'Social Mobility Index' = 86
)
names <- c('Corruption Perception', 'Education Index', 'Health Care Index', 'Gini Coefficient', 'Housing Affordability Index', 'Wealth Share Top 1%', 'Welfare Spending % GDP', 'Price to Income Ratio', 'Health Expenditure Index', 'Mortgage as a % of Income', 'GDP Per Capita', 'Poverty Rate', 'Social Mobility Index')

america2 <- america2 %>%
  rename_with(~names)

america.high.smi <- predict(lm_smi, america2, interval='confidence')
america.high.pov <- predict(lm_pov, america2, interval = 'confidence')
america.high.gdp <- exp(predict(relaxed_lasso_log_gdp, america2, interval = 'confidence')) * 1000


america3 <- data.frame(
'Corruption Perception' = 58.5,
'Education Index' = .86,
'Health Care Index' = 58.8,
'Gini Coefficient' = 0.5,
'Housing Affordability Index' = 2,
'Wealth Share Top 1%' = 27.9,
'Welfare Spending % GDP' = 12.45,
'Price to Income Ratio' = 5.1,
'Health Expenditure Index' = 86, 
'Mortgage as a % of Income' = 86,
'GDP Per Capita' = 86,
'Poverty Rate' = 86,
'Social Mobility Index' = 86
)
# names <- c('Corruption Perception', 'Education Index', 'Health Care Index', 'Gini Coefficient', 'Housing Affordability Index', 'Wealth Share Top 1%', 'Welfare Spending % GDP', 'Price to Income Ratio')

america3 <- america3 %>%
  rename_with(~names)

america.low.smi <- predict(lm_smi, america3, interval='confidence')
america.low.pov <- predict(lm_pov, america3, interval = 'confidence')
america.low.gdp <- exp(predict(relaxed_lasso_log_gdp, america3, interval = 'confidence')) * 1000

america4 <- data.frame(
'Corruption Perception' = 79.5,
'Education Index' = .98,
'Health Care Index' = 75,
'Gini Coefficient' = .28,
'Housing Affordability Index' = 3.3,
'Wealth Share Top 1%' = 15.9,
'Welfare Spending % GDP' = 22.4,
'Price to Income Ratio' = 3.3,
'Health Expenditure Index' = 86, 
'Mortgage as a % of Income' = 86,
'GDP Per Capita' = 86,
'Poverty Rate' = 86,
'Social Mobility Index' = 86
)

# names <- c('Corruption Perception', 'Education Index', 'Health Care Index', 'Gini Coefficient', 'Housing Affordability Index', 'Wealth Share Top 1%', 'Welfare Spending % GDP', 'Price to Income Ratio')

america4 <- america4 %>%
  rename_with(~names)

america.mid.smi <- predict(lm_smi, america4, interval='confidence')
america.mid.pov <- predict(lm_pov, america4, interval = 'confidence')
america.mid.gdp <- exp(predict(relaxed_lasso_log_gdp, america4, interval = 'confidence', level = .95)) * 1000


predicted.smi <- data.frame(c('Predicted', 'Lower', 'Upper'), c(america.high.smi[1], america.high.smi[2], america.high.smi[3]), c(america.low.smi[1], america.low.smi[2], america.low.smi[3]), c(america.mid.smi[1], america.mid.smi[2], america.mid.smi[3]), c(70.4, NA, NA)) %>%
  rename_with(~c('Limits', 'Highball SMI', 'Lowball SMI', 'Midball SMI', 'Real SMI')) %>%            mutate_at(vars('Highball SMI':'Real SMI'), ~ round(., 2))


predicted.pov <- data.frame(c('Predicted', 'Lower', 'Upper'), c(america.high.pov[1], america.high.pov[2], america.high.pov[3]), c(america.low.pov[1], america.low.pov[2], america.low.pov[3]), c(america.mid.pov[1], america.mid.pov[2], america.mid.pov[3]), c(15.2, NA, NA)) %>%
  rename_with(~c('Limits', 'Highball POV', 'Lowball POV', 'Midball POV', 'Real POV')) %>%
   mutate_at(vars('Highball POV':'Real POV'), ~ round(., 2))

predicted.gdp <- data.frame(c('Predicted', 'Lower', 'Upper'), c(america.high.gdp[1], america.high.gdp[2], america.high.gdp[3]), c(america.low.gdp[1], america.low.gdp[2], america.low.gdp[3]), c(america.mid.gdp[1], america.mid.gdp[2], america.mid.gdp[3]), c(75269, NA, NA)) %>%
  rename_with(~c('Limits', 'Highball GDPPC', 'Lowball GDPPC', 'Midball GDPPC', 'Real GDPPC')) %>%
   mutate_at(vars('Highball GDPPC':'Real GDPPC'), ~ round(., 2)) %>%
  mutate_at(vars('Highball GDPPC':'Real GDPPC'), ~ format(., big.mark = ",", scientific = FALSE))

predicted.smi
predicted.pov
predicted.gdp

```


```{r, evaluate=F}
write.csv(no_na.countryinc, "Clean_Data.csv", row.names = FALSE)

```


```{r}

library(mapdata)

# Sample dataframe (replace this with your actual dataframe)
# no_na <- data.frame(
#   Country = c("United States", "Canada", "Brazil", "India", "Australia")
# )

# Get world map data
world_map <- map_data("world")

no_na.countryinc <- no_na.countryinc %>%
  mutate(Country = ifelse(Country == "United States", "USA", Country))
# Create a flag column to highlight the countries
world_map <- world_map %>%
  mutate(highlight = ifelse(region %in% no_na.countryinc$Country, "Used", "Unused"))

ggplot(world_map, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = highlight), color = "black") +
  scale_fill_manual(values = c("Used" = "#2C5F8D", "Unused" = "gray")) +
  theme_void() +
  labs(title = "Used Countries") +
  theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA),
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1),
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1), # Dark blue border
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.background = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.box.background = element_blank(), # Remove the box around the legends
    legend.key = element_rect(fill = "#FAFAFAFF", color = NA), # Remove the border around the legend keys
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D"))


```

```{r}
library(ggplot2)
library(broom)
create_plots <- function(model) {
  # Use broom's augment to get residuals and fitted values
  augmented_data <- augment(model)
  
  # QQ plot
  qq_plot <- ggplot(augmented_data, aes(sample = .resid)) + 
    stat_qq(shape = 21, fill = "#FAFAFAFF", color = "#2C5F8D", size = 2.5, stroke = 1) +
    stat_qq_line(linetype = "dashed", color = "#2C5F8D", size =0.5) +
    ggtitle("QQ Plot") + xlab("Standardized Residuals") + ylab("Theoretical Quantiles")+
    theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA), # Light gray background
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1), # Dark blue border
    panel.grid.major = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.grid.minor = element_line(color = "#d0ddeb"), # Light gray grid lines for contrast
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1), # Dark blue border
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.background = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.box.background = element_blank(), # Remove the box around the legends
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D")
  )
  
  # Residuals vs Fitted values plot
  residual_plot <- ggplot(augmented_data, aes(x = .fitted, y = .resid)) +
  geom_point(shape = 21, fill = "#FAFAFAFF", color = "#2C5F8D", size = 2.5, stroke = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#2C5F8D") +
  geom_smooth(method = "loess", span = 10, se = FALSE, color = "#cfdee7") +
  ggtitle("Residuals vs Fitted Values") +
  xlab("Fitted Values") +
  ylab("Residuals") +
  theme(
    plot.background = element_rect(fill = "#FAFAFAFF", color = NA),
    panel.background = element_rect(fill = "#FAFAFAFF", color = "#2C5F8D", size = 1),
    panel.grid.major = element_line(color = "#d0ddeb"),
    panel.grid.minor = element_line(color = "#d0ddeb"),
    panel.border = element_rect(color = "#2C5F8D", fill = NA, size = 1),
    axis.text = element_text(color = "#2C5F8D"),
    axis.title = element_text(color = "#2C5F8D"),
    plot.title = element_text(color = "#2C5F8D", size = 20, face = "bold"),
    legend.background = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.box.background = element_blank(),
    legend.key = element_rect(fill = "#FAFAFAFF", color = NA),
    legend.title = element_text(color = "#2C5F8D"),
    legend.text = element_text(color = "#2C5F8D")
  )
  
  return(list(qq_plot = qq_plot, residual_plot = residual_plot))
}

#lm_smi<-lm(`Social Mobility Index`~ `Wealth Share Top 1%`+`Gini Coefficient` +`Corruption Perception` , c.data.notest2)
summary(lm_smi)
#relaxed_lasso_log_gdp <- lm(`logGDPPC` ~ `Corruption Perception`, no_na.notestloggdp)
smi_plots <- create_plots(lm_smi)
pov_plots<-create_plots(lm_pov)
gdp_plots <-create_plots(relaxed_lasso_log_gdp)
# 
print(smi_plots$qq_plot)
print(smi_plots$residual_plot)
# 
# print(pov_plots$qq_plot)
# print(pov_plots$residual_plot)
# 
# print(gdp_plots$qq_plot)
# print(gdp_plots$residual_plot)

# plot(relaxed_lasso_log_gdp,1)
# 
# par(bg = "#FAFAFAFF", col.axis = "#2C5F8D", col.lab = "#2C5F8D", col.main = "#2C5F8D", col.sub = "#2C5F8D")
# 
# # Plot with custom parameters
# plot(relaxed_lasso_gdp,bg = "#FAFAFAFF",col = "#2C5F8D", col.axis = "#2C5F8D", col.lab = "#2C5F8D", col.main = "#2C5F8D", col.sub = "#2C5F8D",1)
# plot(relaxed_lasso_gdp)
# # Reset to default parameters
# par(mfrow = c(1, 1))

```

